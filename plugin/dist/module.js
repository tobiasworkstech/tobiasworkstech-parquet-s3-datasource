define(["@grafana/data","@grafana/runtime","rxjs","react","@grafana/ui"],(e,t,a,l,n)=>(()=>{"use strict";var r={7(e){e.exports=n},269(e){e.exports=a},531(e){e.exports=t},781(t){t.exports=e},959(e){e.exports=l}},i={};function o(e){var t=i[e];if(void 0!==t)return t.exports;var a=i[e]={exports:{}};return r[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{plugin:()=>g});var u=o(781),c=o(531),d=o(269);const m={bucket:"",pathPrefix:"",filePattern:"*.parquet",queryText:"",timeColumn:"",columns:[],maxRows:1e4};class p extends u.DataSourceApi{getResourceUrl(e){return`/api/datasources/uid/${this.uid}/resources${e}`}applyTemplateVariables(e,t){const a=(0,c.getTemplateSrv)();return{...e,bucket:a.replace(e.bucket||"",t),pathPrefix:a.replace(e.pathPrefix||"",t),filePattern:a.replace(e.filePattern||"",t),queryText:a.replace(e.queryText||"",t),timeColumn:a.replace(e.timeColumn||"",t)}}async query(e){const{range:t,scopedVars:a}=e,l=e.targets.map(async e=>{if(e.hide)return new u.MutableDataFrame;const l=this.applyTemplateVariables({...m,...e},a);try{var n,r;const a=await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:this.getResourceUrl("/query"),method:"POST",data:{...l,refId:e.refId,timeRange:{from:null==t?void 0:t.from.valueOf(),to:null==t?void 0:t.to.valueOf()}}}));if(console.log("Backend response:",JSON.stringify(a.data,null,2)),null===(r=a.data)||void 0===r||null===(n=r.frames)||void 0===n?void 0:n[0]){var i;const t=a.data.frames[0],l=((null===(i=t.schema)||void 0===i?void 0:i.fields)||[]).map((e,a)=>{var l,n;return{name:e.name,type:this.mapFieldType(e.type),values:(null===(n=t.data)||void 0===n||null===(l=n.values)||void 0===l?void 0:l[a])||[]}});return console.log("Constructing frame with fields:",l.map(e=>{var t;return{name:e.name,valuesLength:null===(t=e.values)||void 0===t?void 0:t.length}})),new u.MutableDataFrame({refId:e.refId,fields:l})}return new u.MutableDataFrame({refId:e.refId,fields:[]})}catch(e){throw console.error("Query error:",e),new Error(`Query failed: ${e.message||"Unknown error"}`)}});return{data:await Promise.all(l)}}mapFieldType(e){return{time:u.FieldType.time,number:u.FieldType.number,string:u.FieldType.string,boolean:u.FieldType.boolean,other:u.FieldType.other}[e]||u.FieldType.string}async testDatasource(){try{var e,t;const l=await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`/api/datasources/uid/${this.uid}/health`,method:"GET"}));var a;return"OK"===(null===(e=l.data)||void 0===e?void 0:e.status)?{status:"success",message:(null===(a=l.data)||void 0===a?void 0:a.message)||"Successfully connected to S3."}:{status:"error",message:(null===(t=l.data)||void 0===t?void 0:t.message)||"Connection failed"}}catch(e){var l;return{status:"error",message:`Connection failed: ${(null===(l=e.data)||void 0===l?void 0:l.message)||e.message||"Unknown error"}`}}}async getSchema(e,t){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:this.getResourceUrl("/schema"),method:"POST",data:{bucket:e,key:t}}))).data}async listFiles(e,t){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:this.getResourceUrl("/files"),method:"POST",data:{bucket:e,prefix:t}}))).data}async listBuckets(){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:this.getResourceUrl("/buckets"),method:"GET"}))).data.buckets}async metricFindQuery(e,t){const a=(0,c.getTemplateSrv)().replace(e,null==t?void 0:t.scopedVars);if(a.match(/^buckets\(\)$/))return(await this.listBuckets()).map(e=>({text:e,value:e}));const l=a.match(/^files\(([^,]+)(?:,\s*(.+))?\)$/);if(l){var n;const e=l[1].trim(),t=(null===(n=l[2])||void 0===n?void 0:n.trim())||"";return(await this.listFiles(e,t)).files.map(e=>({text:e.key,value:e.key}))}const r=a.match(/^columns\(([^,]+),\s*(.+)\)$/);if(r){const e=r[1].trim(),t=r[2].trim();return(await this.getSchema(e,t)).columns.map(e=>({text:e.name,value:e.name}))}return[]}constructor(e){var t,a;super(e),a=void 0,(t="defaultBucket")in this?Object.defineProperty(this,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):this[t]=a,this.defaultBucket=e.jsonData.defaultBucket}}var h=o(959),v=o.n(h),f=o(7);const g=new u.DataSourcePlugin(p).setConfigEditor(function(e){var t,a,l;const{onOptionsChange:n,options:r}=e,{jsonData:i,secureJsonFields:o,secureJsonData:s}=r;return v().createElement(v().Fragment,null,v().createElement(f.FieldSet,{label:"S3 Connection"},v().createElement(f.InlineField,{label:"Endpoint URL",labelWidth:20,tooltip:"S3-compatible endpoint URL (e.g., http://minio:9000 or https://s3.amazonaws.com)"},v().createElement(f.Input,{width:40,value:i.endpoint||"",onChange:e=>{n({...r,jsonData:{...i,endpoint:e.target.value}})},placeholder:"http://minio:9000"})),v().createElement(f.InlineField,{label:"Region",labelWidth:20,tooltip:"AWS region (e.g., us-east-1). For MinIO, use 'us-east-1' as default."},v().createElement(f.Input,{width:40,value:i.region||"",onChange:e=>{n({...r,jsonData:{...i,region:e.target.value}})},placeholder:"us-east-1"})),v().createElement(f.InlineField,{label:"Default Bucket",labelWidth:20,tooltip:"Default bucket to use if not specified in queries"},v().createElement(f.Input,{width:40,value:i.defaultBucket||"",onChange:e=>{n({...r,jsonData:{...i,defaultBucket:e.target.value}})},placeholder:"my-bucket"}))),v().createElement(f.FieldSet,{label:"Authentication"},v().createElement(f.InlineField,{label:"Access Key ID",labelWidth:20,tooltip:"S3 Access Key ID"},v().createElement(f.Input,{width:40,value:i.accessKeyId||"",onChange:e=>{n({...r,jsonData:{...i,accessKeyId:e.target.value}})},placeholder:"AKIAIOSFODNN7EXAMPLE"})),v().createElement(f.InlineField,{label:"Secret Access Key",labelWidth:20,tooltip:"S3 Secret Access Key (stored securely)"},v().createElement(f.SecretInput,{width:40,isConfigured:null!==(t=null==o?void 0:o.secretAccessKey)&&void 0!==t&&t,value:(null==s?void 0:s.secretAccessKey)||"",onChange:e=>{n({...r,secureJsonData:{...s,secretAccessKey:e.target.value}})},onReset:()=>{n({...r,secureJsonFields:{...o,secretAccessKey:!1},secureJsonData:{...s,secretAccessKey:""}})},placeholder:"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"}))),v().createElement(f.FieldSet,{label:"Advanced Options"},v().createElement(f.InlineField,{label:"Path Style",labelWidth:20,tooltip:"Use path-style URLs (required for MinIO and some S3-compatible services)"},v().createElement(f.Switch,{value:null===(a=i.pathStyle)||void 0===a||a,onChange:e=>{n({...r,jsonData:{...i,pathStyle:e.currentTarget.checked}})}})),v().createElement(f.InlineField,{label:"Skip TLS Verify",labelWidth:20,tooltip:"Skip SSL/TLS certificate verification (use with caution)"},v().createElement(f.Switch,{value:null!==(l=i.insecureSkipVerify)&&void 0!==l&&l,onChange:e=>{n({...r,jsonData:{...i,insecureSkipVerify:e.currentTarget.checked}})}}))))}).setQueryEditor(function(e){var t;const{datasource:a,query:l,onChange:n,onRunQuery:r}=e,[i,o]=(0,h.useState)([]),[s,u]=(0,h.useState)([]),[c,d]=(0,h.useState)(!1),[p,g]=(0,h.useState)(!1);(0,h.useEffect)(()=>{(async()=>{d(!0);try{const e=await a.listBuckets();o(e.map(e=>({label:e,value:e})))}catch(e){console.error("Failed to load buckets:",e)}finally{d(!1)}})()},[a]),(0,h.useEffect)(()=>{(async()=>{if(l.bucket){g(!0);try{const e=(await a.listFiles(l.bucket,l.pathPrefix)).files.filter(e=>e.key.endsWith(".parquet"));if(e.length>0){const t=await a.getSchema(l.bucket,e[0].key);u(t.columns)}else u([])}catch(e){console.error("Failed to auto-load schema:",e),u([])}finally{g(!1)}}else u([])})()},[a,l.bucket,l.pathPrefix]);const b=s.map(e=>({label:`${e.name} (${e.type})`,value:e.name}));return v().createElement(v().Fragment,null,v().createElement(f.InlineFieldRow,null,v().createElement(f.InlineField,{label:"Bucket",labelWidth:12,tooltip:"S3 bucket containing Parquet files"},v().createElement(f.Select,{width:25,options:i,value:l.bucket?{label:l.bucket,value:l.bucket}:null,onChange:e=>{n({...l,bucket:(null==e?void 0:e.value)||""})},isLoading:c,placeholder:"Select bucket...",isClearable:!0})),v().createElement(f.InlineField,{label:"Path Prefix",labelWidth:12,tooltip:"Filter files by path prefix (optional, leave empty for root)"},v().createElement(f.Input,{width:20,value:l.pathPrefix||"",onChange:e=>{n({...l,pathPrefix:e.target.value})},onBlur:r,placeholder:"(root)"})),v().createElement(f.InlineField,{label:"File Pattern",labelWidth:12,tooltip:"File pattern to match"},v().createElement(f.Input,{width:15,value:l.filePattern||m.filePattern,onChange:e=>{n({...l,filePattern:e.target.value})},onBlur:r,placeholder:"*.parquet"}))),v().createElement(f.InlineFieldRow,null,v().createElement(f.InlineField,{label:"Time Column",labelWidth:12,tooltip:"Column to use as time field for time series (leave empty for non-time-series data)"},v().createElement(f.Select,{width:25,options:b,value:l.timeColumn?{label:l.timeColumn,value:l.timeColumn}:null,onChange:e=>{n({...l,timeColumn:(null==e?void 0:e.value)||""}),r()},isLoading:p,placeholder:"(none)",isClearable:!0,allowCustomValue:!0})),v().createElement(f.InlineField,{label:"Columns",labelWidth:12,tooltip:"Columns to include (leave empty for all)"},v().createElement(f.MultiSelect,{width:40,options:b,value:(l.columns||[]).map(e=>({label:e,value:e})),onChange:e=>{n({...l,columns:e.map(e=>e.value||"")}),r()},isLoading:p,placeholder:"All columns",allowCustomValue:!0})),v().createElement(f.InlineField,{label:"Max Rows",labelWidth:10,tooltip:"Maximum rows to return"},v().createElement(f.Input,{width:10,type:"number",value:null!==(t=l.maxRows)&&void 0!==t?t:m.maxRows,onChange:e=>{const t=parseInt(e.target.value,10);n({...l,maxRows:isNaN(t)?m.maxRows:t})},onBlur:r}))),v().createElement(f.InlineFieldRow,null,v().createElement(f.InlineField,{label:"Filter",labelWidth:12,tooltip:"Filter condition (optional)",grow:!0},v().createElement(f.TextArea,{value:l.queryText||"",onChange:e=>{n({...l,queryText:e.target.value})},onBlur:r,placeholder:"(none)",rows:1}))))});return s})());
//# sourceMappingURL=module.js.map