define(["@grafana/data","@grafana/runtime","rxjs","react","@grafana/ui"],(e,t,a,l,n)=>(()=>{"use strict";var r={7(e){e.exports=n},269(e){e.exports=a},531(e){e.exports=t},781(t){t.exports=e},959(e){e.exports=l}},i={};function o(e){var t=i[e];if(void 0!==t)return t.exports;var a=i[e]={exports:{}};return r[e](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var a in t)o.o(t,a)&&!o.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};o.r(s),o.d(s,{plugin:()=>y});var u=o(781),c=o(531),d=o(269);const m={bucket:"",pathPrefix:"",filePattern:"*.parquet",queryText:"",timeColumn:"timestamp",columns:[],maxRows:1e4};function p(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class h extends u.DataSourceApi{applyTemplateVariables(e,t){const a=(0,c.getTemplateSrv)();return{...e,bucket:a.replace(e.bucket||"",t),pathPrefix:a.replace(e.pathPrefix||"",t),filePattern:a.replace(e.filePattern||"",t),queryText:a.replace(e.queryText||"",t),timeColumn:a.replace(e.timeColumn||"",t)}}async query(e){const{range:t,scopedVars:a}=e,l=e.targets.map(async e=>{if(e.hide)return new u.MutableDataFrame;const l=this.applyTemplateVariables({...m,...e},a);try{var n,r;const a=await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`${this.url}/query`,method:"POST",data:{...l,refId:e.refId,timeRange:{from:null==t?void 0:t.from.valueOf(),to:null==t?void 0:t.to.valueOf()}}})),s=new u.MutableDataFrame({refId:e.refId,fields:[]});if(null===(r=a.data)||void 0===r||null===(n=r.frames)||void 0===n?void 0:n[0]){var i,o;const e=a.data.frames[0];if(null===(i=e.schema)||void 0===i?void 0:i.fields)for(const t of e.schema.fields){const e=this.mapFieldType(t.type);s.addField({name:t.name,type:e,values:[]})}if(null===(o=e.data)||void 0===o?void 0:o.values)for(let t=0;t<e.data.values.length;t++){const a=e.data.values[t];s.fields[t]&&(s.fields[t].values=a)}}return s}catch(e){throw console.error("Query error:",e),new Error(`Query failed: ${e.message||"Unknown error"}`)}});return{data:await Promise.all(l)}}mapFieldType(e){return{time:u.FieldType.time,number:u.FieldType.number,string:u.FieldType.string,boolean:u.FieldType.boolean,other:u.FieldType.other}[e]||u.FieldType.string}async testDatasource(){try{const e=await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`${this.url}/health`,method:"GET"}));return 200===e.status?{status:"success",message:"Successfully connected to S3 and validated credentials."}:{status:"error",message:`Unexpected response: ${e.status}`}}catch(e){return{status:"error",message:`Connection failed: ${e.message||"Unknown error"}`}}}async getSchema(e,t){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`${this.url}/schema`,method:"POST",data:{bucket:e,key:t}}))).data}async listFiles(e,t){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`${this.url}/files`,method:"POST",data:{bucket:e,prefix:t}}))).data}async listBuckets(){return(await(0,d.lastValueFrom)((0,c.getBackendSrv)().fetch({url:`${this.url}/buckets`,method:"GET"}))).data.buckets}async metricFindQuery(e,t){const a=(0,c.getTemplateSrv)().replace(e,null==t?void 0:t.scopedVars);if(a.match(/^buckets\(\)$/))return(await this.listBuckets()).map(e=>({text:e,value:e}));const l=a.match(/^files\(([^,]+)(?:,\s*(.+))?\)$/);if(l){var n;const e=l[1].trim(),t=(null===(n=l[2])||void 0===n?void 0:n.trim())||"";return(await this.listFiles(e,t)).files.map(e=>({text:e.key,value:e.key}))}const r=a.match(/^columns\(([^,]+),\s*(.+)\)$/);if(r){const e=r[1].trim(),t=r[2].trim();return(await this.getSchema(e,t)).columns.map(e=>({text:e.name,value:e.name}))}return[]}constructor(e){super(e),p(this,"url",void 0),p(this,"defaultBucket",void 0),this.url=e.url,this.defaultBucket=e.jsonData.defaultBucket}}var f=o(959),v=o.n(f),b=o(7);const y=new u.DataSourcePlugin(h).setConfigEditor(function(e){var t,a,l;const{onOptionsChange:n,options:r}=e,{jsonData:i,secureJsonFields:o,secureJsonData:s}=r;return v().createElement(v().Fragment,null,v().createElement(b.FieldSet,{label:"S3 Connection"},v().createElement(b.InlineField,{label:"Endpoint URL",labelWidth:20,tooltip:"S3-compatible endpoint URL (e.g., http://minio:9000 or https://s3.amazonaws.com)"},v().createElement(b.Input,{width:40,value:i.endpoint||"",onChange:e=>{n({...r,jsonData:{...i,endpoint:e.target.value}})},placeholder:"http://minio:9000"})),v().createElement(b.InlineField,{label:"Region",labelWidth:20,tooltip:"AWS region (e.g., us-east-1). For MinIO, use 'us-east-1' as default."},v().createElement(b.Input,{width:40,value:i.region||"",onChange:e=>{n({...r,jsonData:{...i,region:e.target.value}})},placeholder:"us-east-1"})),v().createElement(b.InlineField,{label:"Default Bucket",labelWidth:20,tooltip:"Default bucket to use if not specified in queries"},v().createElement(b.Input,{width:40,value:i.defaultBucket||"",onChange:e=>{n({...r,jsonData:{...i,defaultBucket:e.target.value}})},placeholder:"my-bucket"}))),v().createElement(b.FieldSet,{label:"Authentication"},v().createElement(b.InlineField,{label:"Access Key ID",labelWidth:20,tooltip:"S3 Access Key ID"},v().createElement(b.Input,{width:40,value:i.accessKeyId||"",onChange:e=>{n({...r,jsonData:{...i,accessKeyId:e.target.value}})},placeholder:"AKIAIOSFODNN7EXAMPLE"})),v().createElement(b.InlineField,{label:"Secret Access Key",labelWidth:20,tooltip:"S3 Secret Access Key (stored securely)"},v().createElement(b.SecretInput,{width:40,isConfigured:null!==(t=null==o?void 0:o.secretAccessKey)&&void 0!==t&&t,value:(null==s?void 0:s.secretAccessKey)||"",onChange:e=>{n({...r,secureJsonData:{...s,secretAccessKey:e.target.value}})},onReset:()=>{n({...r,secureJsonFields:{...o,secretAccessKey:!1},secureJsonData:{...s,secretAccessKey:""}})},placeholder:"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"}))),v().createElement(b.FieldSet,{label:"Advanced Options"},v().createElement(b.InlineField,{label:"Path Style",labelWidth:20,tooltip:"Use path-style URLs (required for MinIO and some S3-compatible services)"},v().createElement(b.Switch,{value:null===(a=i.pathStyle)||void 0===a||a,onChange:e=>{n({...r,jsonData:{...i,pathStyle:e.currentTarget.checked}})}})),v().createElement(b.InlineField,{label:"Skip TLS Verify",labelWidth:20,tooltip:"Skip SSL/TLS certificate verification (use with caution)"},v().createElement(b.Switch,{value:null!==(l=i.insecureSkipVerify)&&void 0!==l&&l,onChange:e=>{n({...r,jsonData:{...i,insecureSkipVerify:e.currentTarget.checked}})}}))))}).setQueryEditor(function(e){var t;const{datasource:a,query:l,onChange:n,onRunQuery:r}=e,[i,o]=(0,f.useState)([]),[s,u]=(0,f.useState)([]),[c,d]=(0,f.useState)([]),[p,h]=(0,f.useState)(!1),[y,g]=(0,f.useState)(!1),[S,F]=(0,f.useState)(!1);(0,f.useEffect)(()=>{(async()=>{h(!0);try{const e=await a.listBuckets();o(e.map(e=>({label:e,value:e})))}catch(e){console.error("Failed to load buckets:",e)}finally{h(!1)}})()},[a]),(0,f.useEffect)(()=>{(async()=>{if(l.bucket){g(!0);try{const e=await a.listFiles(l.bucket,l.pathPrefix);u(e.files.filter(e=>e.key.endsWith(".parquet")).map(e=>({label:e.key,value:e.key})))}catch(e){console.error("Failed to load files:",e)}finally{g(!1)}}else u([])})()},[a,l.bucket,l.pathPrefix]);const E=(0,f.useCallback)(async(e,t)=>{F(!0);try{const l=await a.getSchema(e,t);d(l.columns)}catch(e){console.error("Failed to load schema:",e),d([])}finally{F(!1)}},[a]),w=c.map(e=>({label:`${e.name} (${e.type})`,value:e.name}));return v().createElement(v().Fragment,null,v().createElement(b.InlineFieldRow,null,v().createElement(b.InlineField,{label:"Bucket",labelWidth:14,tooltip:"S3 bucket containing Parquet files"},v().createElement(b.Select,{width:30,options:i,value:l.bucket?{label:l.bucket,value:l.bucket}:null,onChange:e=>{n({...l,bucket:e.value||""})},isLoading:p,placeholder:"Select bucket...",isClearable:!0})),v().createElement(b.InlineField,{label:"Path Prefix",labelWidth:14,tooltip:"Filter files by path prefix"},v().createElement(b.Input,{width:30,value:l.pathPrefix||"",onChange:e=>{n({...l,pathPrefix:e.target.value})},onBlur:r,placeholder:"data/2024/"})),v().createElement(b.InlineField,{label:"File Pattern",labelWidth:14,tooltip:"File pattern to match (supports wildcards)"},v().createElement(b.Input,{width:20,value:l.filePattern||m.filePattern,onChange:e=>{n({...l,filePattern:e.target.value})},onBlur:r,placeholder:"*.parquet"}))),v().createElement(b.InlineFieldRow,null,v().createElement(b.InlineField,{label:"Load Schema From",labelWidth:14,tooltip:"Select a file to load column schema"},v().createElement(b.Select,{width:40,options:s,onChange:e=>{e.value&&l.bucket&&E(l.bucket,e.value)},isLoading:y,placeholder:"Select file to load schema...",isClearable:!0}))),v().createElement(b.InlineFieldRow,null,v().createElement(b.InlineField,{label:"Time Column",labelWidth:14,tooltip:"Column to use as time field for time series data"},v().createElement(b.Select,{width:30,options:w,value:l.timeColumn?{label:l.timeColumn,value:l.timeColumn}:null,onChange:e=>{n({...l,timeColumn:e.value||""}),r()},isLoading:S,placeholder:"Select time column...",isClearable:!0,allowCustomValue:!0})),v().createElement(b.InlineField,{label:"Columns",labelWidth:14,tooltip:"Columns to include (leave empty for all)"},v().createElement(b.MultiSelect,{width:50,options:w,value:(l.columns||[]).map(e=>({label:e,value:e})),onChange:e=>{n({...l,columns:e.map(e=>e.value||"")}),r()},isLoading:S,placeholder:"Select columns...",allowCustomValue:!0}))),v().createElement(b.InlineFieldRow,null,v().createElement(b.InlineField,{label:"Max Rows",labelWidth:14,tooltip:"Maximum number of rows to return"},v().createElement(b.Input,{width:15,type:"number",value:null!==(t=l.maxRows)&&void 0!==t?t:m.maxRows,onChange:e=>{const t=parseInt(e.target.value,10);n({...l,maxRows:isNaN(t)?m.maxRows:t})},onBlur:r}))),v().createElement(b.InlineFieldRow,null,v().createElement(b.InlineField,{label:"SQL Filter",labelWidth:14,tooltip:"SQL-like WHERE clause to filter data (e.g., 'value > 100 AND status = active')",grow:!0},v().createElement(b.TextArea,{value:l.queryText||"",onChange:e=>{n({...l,queryText:e.target.value})},onBlur:r,placeholder:"value > 100 AND status = 'active'",rows:2}))))});return s})());
//# sourceMappingURL=module.js.map