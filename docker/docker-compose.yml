version: '3.8'

services:
  # MinIO S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: minio
    ports:
      - "9000:9000"      # S3 API
      - "9001:9001"      # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - grafana-net

  # MinIO setup - creates bucket and uploads sample data
  minio-setup:
    image: python:3.11-alpine
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
      BUCKET_NAME: ${BUCKET_NAME:-parquet-data}
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Installing dependencies..."
        pip install --no-cache-dir pandas pyarrow minio

        echo "Creating sample parquet data and uploading to MinIO..."
        python3 << 'EOF'
        import pandas as pd
        import numpy as np
        from datetime import datetime, timedelta
        from minio import Minio
        import os

        # Create MinIO client
        client = Minio(
            "minio:9000",
            access_key=os.environ["MINIO_ROOT_USER"],
            secret_key=os.environ["MINIO_ROOT_PASSWORD"],
            secure=False
        )

        bucket_name = os.environ["BUCKET_NAME"]

        # Create bucket if it doesn't exist
        if not client.bucket_exists(bucket_name):
            client.make_bucket(bucket_name)
            print(f"Created bucket: {bucket_name}")
        else:
            print(f"Bucket {bucket_name} already exists")

        # Generate sample data
        base_time = datetime.now() - timedelta(days=7)
        timestamps = [base_time + timedelta(hours=i) for i in range(168)]

        data = {
            'timestamp': timestamps,
            'temperature': np.random.normal(25, 5, 168).round(2),
            'humidity': np.random.uniform(30, 80, 168).round(2),
            'pressure': np.random.normal(1013, 10, 168).round(2),
            'location': np.random.choice(['sensor_1', 'sensor_2', 'sensor_3'], 168),
            'status': np.random.choice(['normal', 'warning', 'critical'], 168, p=[0.8, 0.15, 0.05])
        }

        df = pd.DataFrame(data)

        # Save and upload main file
        df.to_parquet('/tmp/sample_metrics.parquet', index=False)
        client.fput_object(bucket_name, 'sample_metrics.parquet', '/tmp/sample_metrics.parquet')
        print(f"Uploaded sample_metrics.parquet with {len(df)} rows")

        # Create daily files
        for date in pd.date_range(base_time.date(), periods=7):
            daily_df = df[pd.to_datetime(df['timestamp']).dt.date == date.date()]
            if not daily_df.empty:
                filename = f'/tmp/metrics_{date.strftime("%Y%m%d")}.parquet'
                object_name = f'daily/metrics_{date.strftime("%Y%m%d")}.parquet'
                daily_df.to_parquet(filename, index=False)
                client.fput_object(bucket_name, object_name, filename)
                print(f"Uploaded {object_name} with {len(daily_df)} rows")

        # List all objects
        print("\nBucket contents:")
        for obj in client.list_objects(bucket_name, recursive=True):
            print(f"  {obj.object_name} ({obj.size} bytes)")

        print("\nMinIO setup complete!")
        EOF
    networks:
      - grafana-net

  # Build the plugin
  plugin-builder:
    build:
      context: ..
      dockerfile: docker/Dockerfile.plugin
    container_name: plugin-builder
    volumes:
      - plugin_dist:/app/dist

  # Grafana with the parquet-s3 plugin
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD:-admin123}
      GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS: tobiasworkstech-parquets3-datasource
      GF_LOG_LEVEL: debug
    volumes:
      - grafana_data:/var/lib/grafana
      - plugin_dist:/var/lib/grafana/plugins/tobiasworkstech-parquets3-datasource:ro
      - ./provisioning:/etc/grafana/provisioning:ro
    depends_on:
      minio:
        condition: service_healthy
      plugin-builder:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3000/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - grafana-net

networks:
  grafana-net:
    driver: bridge

volumes:
  minio_data:
  grafana_data:
  plugin_dist:
